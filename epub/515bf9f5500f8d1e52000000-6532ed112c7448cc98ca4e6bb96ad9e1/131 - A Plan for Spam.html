<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html lang="en"><head><title>
   A Plan for Spam
  </title></head><body>
  <h1><span class="s s1">
   A Plan for Spam
  </span></h1>
  <h2>
   </h2><p><span class="s s2">
    August 2002
   </span></p>
   <p><span class="s s3">
    <i>
     (This article describes the spam-filtering techniques
used in the spamproof web-based mail reader we
built to exercise
     <a target="_blank" href="http://paulgraham.com/arc.html">
      Arc
     </a>
     . An
improved algorithm is described in
     <a target="_blank" href="http://paulgraham.com/better.html">
      Better
Bayesian Filtering
     </a>
     .)
    </i>
   </span></p>
   <p>
    <span class="s s4">I think it's possible to stop spam, and that 
content-based filters are the way to do it.</span>
<span class="s s5">The Achilles heel of the spammers is their message.</span>
<span class="s s6">They can circumvent any other barrier you set up.</span>  <span class="s s7">They have so far, at
least.</span>  <span class="s s8">But they have to deliver their message, whatever it
is.</span>  <span class="s s9">If we can write software that recognizes their messages,
there is no way they can get around that.</span>
   </p>
   <p>
    </p><center><span class="s s11">
     _ _ _
    </span></center>
   
   <p>
    <span class="s s12">To the recipient, spam is easily recognizable.</span>  <span class="s s13">If you hired 
someone to read your mail and discard the spam, they would
have little trouble doing it.</span>  <span class="s s14">How much do we have
to do, short of AI, to automate this process?</span>
   </p>
   <p>
    <span class="s s16">I think we will be able to solve the problem with fairly
simple algorithms.  In fact, I've found that you can filter
present-day spam acceptably well using nothing more than a
Bayesian combination of the spam probabilities of individual
words.</span>  <span class="s s17">Using a slightly tweaked (as described below) Bayesian
filter, we now miss less than 5 per 1000 spams, with 0 false positives.</span>
   </p>
   <p>
    <span class="s s19">The statistical approach is not usually the first one people
try when they write spam filters.</span>  <span class="s s20">Most hackers' first instinct is
to try to write software that recognizes individual properties of
spam.</span>  <span class="s s21">You look at spams
and you think, the gall of these guys to try sending me mail 
that begins "Dear Friend" or has a subject line that's all
uppercase and ends in eight exclamation points.</span>  <span class="s s22">I can filter
out that stuff with about one line of code.</span>
   </p>
   <p>
    <span class="s s24">And so you do,
and in the beginning it works.</span>  <span class="s s25">A few simple rules will take
a big bite out of your incoming spam.</span>  <span class="s s26">Merely looking
for the word "click" will catch 79.</span><span class="s s27">7% of the
emails in my spam corpus, with only 1.</span><span class="s s28">2% false positives.</span>
   </p>
   <p>
    <span class="s s30">I spent about six months writing software that looked for
individual spam features before I tried the statistical
approach.</span>  <span class="s s31">What I found was that recognizing that last few
percent of spams got very hard, and that as I
made the filters stricter I got more false positives.</span>
   </p>
   <p>
    <span class="s s33">False positives are innocent emails that get mistakenly
identified as spams.
For most users,
missing legitimate email is
an order of magnitude worse than receiving spam, so a
filter that yields false positives is like an acne cure
that carries a risk of death to the patient.</span>
   </p>
   <p>
    <span class="s s35">The more spam a user gets, the less
likely he'll be to notice one innocent mail sitting in his
spam folder.</span>  <span class="s s36">And strangely enough, the better your spam filters get,
the more dangerous false positives become, because when the
filters are really good, users will be more likely to
ignore everything they catch.</span>
   </p>
   <p>
    <span class="s s38">I don't know why I avoided trying the statistical approach
for so long.</span>  <span class="s s39">I think it was because I got addicted to
trying to identify spam features myself, as if I were playing
some kind of competitive game with the spammers.</span>  <span class="s s40">(Nonhackers
don't often realize this, but most hackers are very competitive.</span><span class="s s41">)
When I did try statistical analysis, I
found immediately that it was much cleverer than I had been.</span>
<span class="s s42">It discovered, of course, that terms like "virtumundo" and
"teens" were good indicators of spam.</span>  <span class="s s43">But it also
discovered that "per" and "FL" and "ff0000" are good 
indicators of spam.</span>  <span class="s s44">In fact, "ff0000" (html for bright red)
turns out to be as good an indicator of spam as any  
pornographic term.</span>
   </p>
   <p>
    </p><center><span class="s s46">
     _ _ _
    </span></center>
   
   <p>
    <span class="s s47">Here's a sketch of how I do statistical filtering.</span>  <span class="s s48">I start
with one corpus of spam and one of nonspam mail.</span>  <span class="s s49">At the
moment each one has about 4000 messages in it.</span>  <span class="s s50">I scan
the entire text, including headers and embedded html
and javascript, of each message in each corpus.</span>
<span class="s s51">I currently consider alphanumeric characters,
dashes, apostrophes, and dollar signs to be part of tokens,
and everything else to be a token separator.</span>  <span class="s s52">(There is
probably room for improvement here.</span><span class="s s53">)  I ignore tokens that
are all digits, and I also ignore html comments, not even
considering them as token separators.</span>
   </p>
   <p>
    <span class="s s55">I count the number
of times each token (ignoring case, currently) occurs in
each corpus.</span>  <span class="s s56">At this stage I end up with two large hash   
tables, one for each corpus, mapping tokens to number
of occurrences.</span>
   </p>
   <p>
    <span class="s s58">Next I create a third hash table, this time mapping
each token to the probability that an email containing it is a spam,
which I calculate as follows [1]:</span>
    </p><xmp>
     <span class="s s59">(let ((g (* 2 (or (gethash word good) 0)))
      (b (or (gethash word bad) 0)))
   (unless (&lt; (+ g b) 5)
     (max .</span><span class="s s60">01
          (min .</span><span class="s s61">99 (float (/ (min 1 (/ b nbad))
                             (+ (min 1 (/ g ngood))   
                                (min 1 (/ b nbad)))))))))</span>
    </xmp><span class="s s62">
    where
                                    
                                     word
                                    
                                    is the token whose probability we're
calculating,
                                    
                                     good
                                    
                                    and
                                    
                                     bad
                                    
                                    are the hash tables
I created in the first step, and
                                    
                                     ngood
                                    
                                    and
                                    
                                     nbad
                                    
                                    are the number of nonspam and spam messages respectively.
   
   </span><p>
    <span class="s s63">I explained this as code to show a couple of important details.</span>
<span class="s s64">I want to bias the probabilities slightly to avoid false
positives, and by trial and error I've found that a good
way to do it is to double all the numbers in
                                      
                                       good
                                      
                                      .</span>
<span class="s s65">This helps to distinguish between words that occasionally
do occur in legitimate email and words that almost never do.</span> 
<span class="s s66">I only consider words that occur more than five times in
total (actually, because of the doubling, occurring three 
times in nonspam mail would be enough).</span>  <span class="s s67">And then there is
the question of what probability to assign to words that
occur in one corpus but not the other.</span>  <span class="s s68">Again by trial and   
error I chose .</span><span class="s s69">01 and .</span><span class="s s70">99.</span>  <span class="s s71">There may be room for tuning
here, but as the corpus grows such tuning will happen
automatically anyway.</span>
   </p>
   <p>
    <span class="s s73">The especially observant will notice that while I consider
each corpus to be a single long stream of text for purposes
of counting occurrences, I use the number of emails in
each, rather than their combined length, as the divisor     
in calculating spam probabilities.</span>  <span class="s s74">This adds another
slight bias to protect against false positives.</span>
   </p>
   <p>
    <span class="s s76">When new mail arrives, it is scanned into tokens, and
the most interesting fifteen tokens, where interesting is  
measured by how far their spam probability is from a
neutral .</span><span class="s s77">5, are used to calculate the probability that
the mail is spam.</span><span class="s s78">  If
                                          
                                           probs
                                          
                                          is a list of the fifteen individual probabilities, you
calculate the
    <a target="_blank" href="http://paulgraham.com/naivebayes.html">
     combined
    </a>
    probability thus:
    </span></p><xmp>
     <span class="s s79">(let ((prod (apply #'* probs)))
  (/ prod (+ prod (apply #'* (mapcar #'(lambda (x) 
                                         (- 1 x))
                                     probs)))))</span>
    </xmp><span class="s s80">
    One question that arises in
practice is what probability to assign to a word you've
never seen, i.e. one that doesn't occur in the hash table
of word probabilities.  I've found, again by trial and
error, that .4 is a good number to use.  If you've never
seen a word before, it is probably fairly innocent; spam
words tend to be all too familiar.
   
   </span><p><span class="s s81">
    There are examples of this algorithm being applied to
actual emails in an appendix at the end.
   </span></p>
   <p>
    <span class="s s82">I treat mail as spam if the algorithm above gives it a
probability of more than .</span><span class="s s83">9 of being spam.</span>  <span class="s s84">But in practice
it would not matter much where I put this threshold, because
few probabilities end up in the middle of the range.</span>
   </p>
   <p>
    </p><center><span class="s s86">
     _ _ _
    </span></center>
   
   <p>
    <span class="s s87">One great advantage of the statistical approach is that you
don't have to read so many spams.  Over the past six months,
I've read literally thousands of spams, and it is really
kind of demoralizing.</span>  <span class="s s88">Norbert Wiener said if you compete
with slaves you become a slave, and there is something
similarly degrading about competing with spammers.</span>   <span class="s s89">To
recognize individual spam features you have to try to get
into the mind of the spammer, and frankly I want to spend
as little time inside the minds of spammers as possible.</span>
   </p>
   <p>
    <span class="s s91">But the real advantage of the Bayesian approach, of course,
is that you know what
you're measuring.</span>  <span class="s s92">Feature-recognizing filters like
SpamAssassin assign a spam "score" to email.</span>  <span class="s s93">The Bayesian
approach assigns an actual probability.</span>  <span class="s s94">The problem with
a "score" is that no one knows what it means.</span>  <span class="s s95">The user
doesn't know what it means, but worse still, neither does
the developer of the filter.</span><span class="s s96">  How many
    <i>
     points
    </i>
    should an
email get for having the word "sex" in it?</span>  <span class="s s97">A probability
can of course be mistaken, but there is little ambiguity
about what it means, or how evidence should be combined
to calculate it.</span>  <span class="s s98">Based on my corpus, "sex" indicates
a .</span><span class="s s99">97 probability of the containing email being a spam,
whereas "sexy" indicates .</span><span class="s s100">99 probability.</span>
<span class="s s101">And Bayes' Rule, equally unambiguous, says that an email
containing both words would, in the (unlikely)
absence of any other evidence, have a 99.</span><span class="s s102">97% chance of
being a spam.</span>
   </p>
   <p>
    <span class="s s104">Because it is measuring probabilities, the Bayesian approach
considers all the evidence in the email, both good and bad.</span><span class="s s105">
Words that occur disproportionately
    <i>
     rarely
    </i>
    in spam (like "though" or "tonight" or "apparently")
contribute as much to decreasing the probability as
bad words like "unsubscribe" and "opt-in" do to
increasing it.</span>  <span class="s s106">So an otherwise innocent email that happens
to include the word "sex" is not going to get tagged as spam.</span>
   </p>
   <p>
    <span class="s s108">Ideally, of course, the probabilities should be calculated
individually for each user.</span>  <span class="s s109">I get a lot of email containing
the word "Lisp", and (so far) no spam that does.</span>  <span class="s s110">So a word
like that is effectively a kind of password for sending
mail to me.</span>  <span class="s s111">In my earlier spam-filtering software, the user
could set up a list of such words and mail containing
them would automatically get past the filters.</span>  <span class="s s112">On my
list I put words like "Lisp" and also my zipcode, so
that (otherwise rather spammy-sounding) receipts from
online orders would get through.</span>  <span class="s s113">I thought I was being
very clever, but I found that the Bayesian filter did the
same thing for me, and moreover discovered of a lot of words I
hadn't thought of.</span>
   </p>
   <p>
    <span class="s s115">When I said at the start that our filters let through less than
5 spams per 1000 with 0 false positives, I'm talking about
filtering my mail based on a corpus of my mail.</span>  <span class="s s116">But these
numbers are not misleading, because that is the approach I'm
advocating: filter each user's mail based on the spam and
nonspam mail he receives.</span>  <span class="s s117">Essentially, each user should
have two delete buttons, ordinary delete and delete-as-spam.</span>
<span class="s s118">Anything deleted as spam goes into the spam corpus,   
and everything else goes into the nonspam corpus.</span>
   </p>
   <p>
    <span class="s s120">You could start
users with a seed filter, but ultimately each user should have
his own per-word probabilities based on the actual mail he
receives.</span>  <span class="s s121">This (a) makes the filters more effective, (b) lets
each user decide their own precise definition of spam,
and (c) perhaps best of all makes it hard for spammers
to tune mails to get through the filters.</span>  <span class="s s122">If a lot of the  
brain of the filter is in the individual databases, then 
merely tuning spams to get through the seed filters
won't guarantee anything about how well they'll get through
individual users' varying and much more trained filters.</span>
   </p>
   <p>
    <span class="s s124">Content-based spam filtering is often combined with a whitelist,
a list of senders whose mail can be accepted with no filtering.</span>
<span class="s s125">One easy way to build such a
whitelist is to keep a list of every address the user has
ever sent mail to.</span>  <span class="s s126">If a mail reader has a delete-as-spam
button then you could also add the from address
of every email the user has deleted as ordinary trash.</span>
   </p>
   <p>
    <span class="s s128">I'm an advocate of whitelists, but more as a way to save  
computation than as a way to improve filtering.</span>  <span class="s s129">I used to think that
whitelists would make filtering easier, because you'd
only have to filter email from people you'd never heard
from, and someone sending you mail for the first time is
constrained by convention in what they can say to you.</span>
<span class="s s130">Someone you already know might send you an email talking about sex,
but someone sending you mail for the first time would not   
be likely to.</span>  <span class="s s131">The problem is, people can have more than one 
email address, so a new from-address doesn't guarantee that
the sender is writing to you for the first time.</span>
<span class="s s132">It is not unusual
for an old friend (especially if he is a hacker) to suddenly
send you an email with a new from-address, so you can't
risk false positives by filtering mail from unknown  
addresses especially stringently.</span>
   </p>
   <p>
    <span class="s s134">In a sense, though, my filters do themselves embody a kind
of whitelist (and blacklist) because they are based on
entire messages, including the headers.</span>  <span class="s s135">So to that
extent they "know" the email addresses of trusted senders
and even the routes by which mail gets from them to me.</span>   
<span class="s s136">And they know the same about spam, including the server   
names, mailer versions, and protocols.</span>
   </p>
   <p>
    </p><center><span class="s s138">
     _ _ _
    </span></center>
   
   <p>
    <span class="s s139">If I thought that I could keep up current rates of spam
filtering, I would consider this problem solved.</span>  <span class="s s140">But it
doesn't mean much to be able to filter out most present-day
spam, because spam evolves.</span><span class="s s141">
Indeed, most
    <a target="_blank" href="http://paulgraham.com/falsepositives.html">
     antispam techniques
    </a>
    so far have been like pesticides that
do nothing more than create a new, resistant strain of bugs.</span>
   </p>
   <p>
    <span class="s s143">I'm more hopeful about Bayesian filters, because they evolve
with the spam.</span>  <span class="s s144">So as spammers start using "c0ck"   
instead of "cock" to evade simple-minded spam filters     
based on individual words, Bayesian filters automatically
notice.</span>  <span class="s s145">Indeed, "c0ck" is far more damning evidence than
"cock", and Bayesian filters know precisely how much more.</span>
   </p>
   <p>
    <span class="s s147">Still, anyone who proposes a plan for spam filtering has to
be able to answer the question: if the spammers knew
exactly what you were doing,
how well could they get past you?</span>  <span class="s s148">For example, I think that if
checksum-based spam filtering becomes a serious obstacle,
the spammers will just
switch to mad-lib techniques for generating message bodies.</span>
   </p>
   <p>
    <span class="s s150">To beat Bayesian filters, it would not be enough for spammers
to make their emails unique or to stop using individual
naughty words.</span>  <span class="s s151">They'd have to make their mails indistinguishable
from your ordinary mail.</span>  <span class="s s152">And this I think would severely
constrain them.</span>  <span class="s s153">Spam is mostly sales
pitches, so unless your regular mail is all sales pitches,
spams will inevitably have a different character.</span>  <span class="s s154">And    
the spammers would also, of course, have to change (and keep 
changing) their whole infrastructure, because otherwise
the headers would look as bad to the Bayesian filters as ever,
no matter what they did to the message body.</span>  <span class="s s155">I don't know
enough about the infrastructure that spammers use to know
how hard it would be to make the headers look innocent, but
my guess is that it would be even harder than making the    
message look innocent.</span>
   </p>
   <p><span class="s s157">
    Assuming they could solve the problem of the headers,
the spam of the future will probably look something like
this:
    </span></p><xmp><span class="s s158">
     Hey there.  Thought you should check out the following:
http://www.27meg.com/foo
    </span></xmp><span class="s s159">
    because that is about as much sales pitch as content-based
filtering will leave the spammer room to make.  (Indeed, it
will be hard even to get this past filters, because if everything
else in the email is neutral, the spam probability will hinge on
the url, and it will take some effort to make that look neutral.)
   
   </span><p>
    <span class="s s160">Spammers range from businesses running so-called
opt-in lists who don't even try to conceal their identities,
to guys who hijack mail servers to send out spams promoting
porn sites.</span>  <span class="s s161">If we use filtering to whittle their
options down to mails like the one above, that should
pretty much put the spammers on the "legitimate" end of
the spectrum out of business; they feel obliged
by various state laws to include boilerplate about why
their spam is not spam, and how to cancel your
"subscription,"  and that kind of text is easy to   
recognize.</span>
   </p>
   <p>
    <span class="s s163">(I used to think it was naive to believe that stricter laws
would decrease spam.</span><span class="s s164">  Now I think that while stricter laws  
may not decrease the amount of spam that spammers
    <i>
     send,
    </i>
    they can certainly help filters to decrease the amount of  
spam that recipients actually see.</span><span class="s s165">)</span>
   </p>
   <p>
    <span class="s s166">All along the spectrum, if you restrict the sales pitches spammers
can make, you will inevitably tend to put them out of
business.</span><span class="s s167">  That word
    <i>
     business
    </i>
    is an important one to
remember.</span>  <span class="s s168">The spammers are businessmen.</span>  <span class="s s169">They send spam because
it works.</span>  <span class="s s170">It works because although the response rate
is abominably low (at best 15 per million, vs 3000 per
million for a catalog mailing), the cost, to them, is  
practically nothing.</span>  <span class="s s171">The cost is enormous for the recipients,   
about 5 man-weeks for each million recipients who spend  
a second to delete the spam, but the spammer
doesn't have to pay that.</span>
   </p>
   <p>
    <span class="s s173">Sending spam does cost the spammer something, though.</span> <span class="s s174">[2]
So the lower we can get the
response rate-- whether by filtering, or by using filters to force
spammers to dilute their pitches-- the fewer businesses will find it
worth their while to send spam.</span>
   </p>
   <p><span class="s s176">
    The reason the spammers use the kinds of
    <a target="_blank" href="http://www.milliondollaremails.com">
     sales
pitches
    </a>
    that they do is to increase response rates.</span><span class="s s177">
This is possibly even more disgusting
than getting inside the mind of a spammer,
but let's take a quick look inside the mind of someone
who
    <i>
     responds
    </i>
    to a spam.</span>  <span class="s s178">This person is either
astonishingly credulous or deeply in denial about their   
sexual interests.</span>  <span class="s s179">In either case, repulsive or
idiotic as the spam seems to us, it is exciting
to them.</span>  <span class="s s180">The spammers wouldn't say these things if they
didn't sound exciting.</span>  <span class="s s181">And "thought you
should check out the following" is just not going to
have nearly the pull with the spam recipient as
the kinds of things that spammers say now.</span>
<span class="s s182">Result: if it can't contain exciting sales pitches,
spam becomes less effective as a marketing vehicle,
and fewer businesses want to use it.</span>
   </p>
   <p>
    <span class="s s184">That is the big win in the end.</span>  <span class="s s185">I started writing spam
filtering software because I didn't want have to look at
the stuff anymore.</span>
<span class="s s186">But if we get good enough at filtering
out spam, it will stop working, and the spammers
will actually stop sending it.</span>
   </p>
   <p>
    </p><center><span class="s s188">
     _ _ _
    </span></center>
   
   <p>
    <span class="s s189">Of all the approaches to fighting spam, from software to laws,
I believe Bayesian filtering will be the single most
effective.</span>  <span class="s s190">But I also
think that the more different kinds of antispam efforts
we undertake, the better, because any measure that
constrains spammers will tend to make filtering easier.</span>
<span class="s s191">And even within the world of content-based filtering, I think
it will be a good thing if there are many different kinds
of software being used simultaneously.</span>  <span class="s s192">The more different 
filters there are, the harder it will be for
spammers to tune spams to get through them.</span>
   </p>
   <p>
   </p>
   <h3><span class="s s194">
    Appendix: Examples of Filtering
   </span></h3>
   <p><span class="s s195">
    <a target="_blank" href="http://lib.store.yahoo.net/lib/paulgraham/spam1.txt" target="txtwin">
     Here
    </a>
    is an example of a spam that arrived while I was writing
this article.</span>  <span class="s s196">The fifteen most interesting words in this spam are:</span>
    </p><xmp><span class="s s197">
     qvp0045
indira
mx-05
intimail
$7500
freeyankeedom
cdo
bluefoxmedia
jpg
unsecured
platinum
3d0
qves
7c5
7c266675
    </span></xmp><span class="s s198">
    The words are a mix of stuff from the headers and from the
message body, which is typical of spam.  Also typical of spam
is that every one of these words has a spam probability,
in my database, of .99.  In fact there are more than fifteen words
with probabilities of .99, and these are just the first
fifteen seen.
   
   </span><p>
    <span class="s s199">Unfortunately that makes this email a boring example of
the use of Bayes' Rule.</span><span class="s s200">  To see an interesting variety of
probabilities we have to look at
    <a target="_blank" href="http://lib.store.yahoo.net/lib/paulgraham/spam2.txt" target="txtwin">
     this
    </a>
    actually quite
atypical spam.</span>
   </p>
   <p><span class="s s202">
    The fifteen most interesting words in this spam, with their probabilities,
are:
    </span></p><xmp>
     <span class="s s203">madam           0.</span><span class="s s204">99
promotion       0.</span><span class="s s205">99
republic        0.</span><span class="s s206">99
shortest        0.</span><span class="s s207">047225013
mandatory       0.</span><span class="s s208">047225013
standardization 0.</span><span class="s s209">07347802
sorry           0.</span><span class="s s210">08221981
supported       0.</span><span class="s s211">09019077
people's        0.</span><span class="s s212">09019077
enter           0.</span><span class="s s213">9075001
quality         0.</span><span class="s s214">8921298
organization    0.</span><span class="s s215">12454646
investment      0.</span><span class="s s216">8568143
very            0.</span><span class="s s217">14758544
valuable        0.</span><span class="s s218">82347786</span>
    </xmp><span class="s s219">
    This time the evidence is a mix of good and bad.  A word like  
"shortest" is almost as much evidence for innocence as a
word like "madam" or "promotion" is for guilt.  But still the
case for guilt is stronger.  If you combine these numbers
according to Bayes' Rule, the resulting probability is .9027.
   
   </span><p>
    <span class="s s220">"Madam" is obviously from spams beginning
"Dear Sir or Madam.</span><span class="s s221">"</span><span class="s s222">  They're not very common, but the
word "madam"
    <i>
     never
    </i>
    occurs in my legitimate email, and
it's all about the ratio.</span>
   </p>
   <p>
    <span class="s s224">"Republic" scores high because
it often shows up in Nigerian scam emails, and also occurs once
or twice in spams referring to Korea and South Africa.</span>
<span class="s s225">You might say that it's
an accident that it thus helps identify this spam.</span>  <span class="s s226">But I've
found when examining spam probabilities that there are
a lot of these accidents, and they have an uncanny tendency to
push things in the right direction rather than the wrong one.</span>
<span class="s s227">In this case, it is not entirely a coincidence that the word
"Republic" occurs in Nigerian scam emails and this spam.</span>
<span class="s s228">There is a whole class of dubious business propositions involving
less developed countries, and these in turn are more likely
to have names that specify explicitly (because they aren't) that they
are republics.</span><span class="s s229">[3]</span>
   </p>
   <p>
    <span class="s s230">On the other hand, "enter" is a genuine miss.</span>  <span class="s s231">It occurs
mostly in unsubscribe instructions, but here is used in a
completely innocent way.</span>  <span class="s s232">Fortunately the statistical approach is
fairly robust, and can tolerate quite a lot of misses
before the results start to be thrown off.</span>
   </p>
   <p><span class="s s234">
    For comparison,
    <a target="_blank" href="http://lib.store.yahoo.net/lib/paulgraham/hostexspam.txt" target="txtwin">
     here
    </a>
    is an example of that rare bird, a spam that
gets through the filters.</span>  <span class="s s235">Why?</span>  <span class="s s236">Because by sheer chance it happens
to be loaded with words that occur in my actual email:</span>
    </p><xmp>
     <span class="s s237">perl       0.</span><span class="s s238">01
python     0.</span><span class="s s239">01
tcl        0.</span><span class="s s240">01
scripting  0.</span><span class="s s241">01
morris     0.</span><span class="s s242">01
graham     0.</span><span class="s s243">01491078
guarantee  0.</span><span class="s s244">9762507
cgi        0.</span><span class="s s245">9734398
paul       0.</span><span class="s s246">027040077
quite      0.</span><span class="s s247">030676773
pop3       0.</span><span class="s s248">042199217
various    0.</span><span class="s s249">06080265
prices     0.</span><span class="s s250">9359873
managed    0.</span><span class="s s251">06451222
difficult  0.</span><span class="s s252">071706355</span>
    </xmp><span class="s s253">
    There are a couple pieces of good news here.  First, this mail
probably wouldn't get through the filters of someone who didn't
happen to specialize in programming languages and have a good
friend called Morris.  For the average user, all the top five words here 
would be neutral and would not contribute to the spam probability.
   
   </span><p>
    <span class="s s254">Second, I think filtering based on word pairs 
(see below) might well
catch this one:  "cost effective", "setup fee", "money back" -- pretty
incriminating stuff.</span>  <span class="s s255">And of course if they continued to spam me
(or a network I was part of), "Hostex" itself would be
recognized as  a spam term.</span>
   </p>
   <p><span class="s s257">
    Finally,
    <a target="_blank" href="http://lib.store.yahoo.net/lib/paulgraham/legit.txt" target="txtwin">
     here
    </a>
    is an innocent email.
Its  fifteen most interesting words are as follows:
    </span></p><xmp>
     <span class="s s258">continuation  0.</span><span class="s s259">01
describe      0.</span><span class="s s260">01
continuations 0.</span><span class="s s261">01
example       0.</span><span class="s s262">033600237
programming   0.</span><span class="s s263">05214485 
i'm           0.</span><span class="s s264">055427782
examples      0.</span><span class="s s265">07972858 
color         0.</span><span class="s s266">9189189  
localhost     0.</span><span class="s s267">09883721
hi            0.</span><span class="s s268">116539136
california    0.</span><span class="s s269">84421706
same          0.</span><span class="s s270">15981844
spot          0.</span><span class="s s271">1654587
us-ascii      0.</span><span class="s s272">16804294
what          0.</span><span class="s s273">19212411</span>
    </xmp><span class="s s274">
    Most of the words here indicate the mail is an innocent one.
There are two bad smelling words,  "color"
(spammers love colored fonts) and "California"
(which occurs in testimonials and also in menus in
forms), but they are not enough to outweigh obviously
innocent words like "continuation" and "example".
   
   </span><p>
    <span class="s s275">It's interesting that "describe" rates as so thoroughly
innocent.</span>  <span class="s s276">It hasn't occurred in a
single one of my 4000 spams.  The data turns out to be
full of such surprises.</span>  <span class="s s277">One of the things you learn
when you analyze spam texts is how
narrow a subset of the language spammers operate in.</span>  <span class="s s278">It's
that fact, together with the equally characteristic vocabulary
of any individual user's mail, that makes Bayesian filtering
a good bet.</span>
   </p>
   <h3><span class="s s280">
    Appendix: More Ideas
   </span></h3>
   <p>
    <span class="s s281">One idea that I haven't tried yet is to filter based on
word pairs, or even triples, rather than individual words.</span>
<span class="s s282">This should yield a much sharper estimate of the probability.</span>
<span class="s s283">For example, in my current database, the word "offers"
has a probability of .</span><span class="s s284">96.</span>  <span class="s s285">If you based the probabilities  
on word pairs, you'd end up with "special offers"
and "valuable offers" having probabilities of .</span><span class="s s286">99
and, say, "approach offers" (as in "this approach offers")
having a probability of .</span><span class="s s287">1 or less.</span>
   </p>
   <p>
    <span class="s s289">The reason I haven't done this is that filtering based on
individual words already works so well.</span>  <span class="s s290">But it does
mean that there is room to tighten the filters if spam
gets harder to detect.</span>
<span class="s s291">(Curiously, a filter based on word pairs would be
in effect a Markov-chaining text generator running
in reverse.</span><span class="s s292">)</span>
   </p>
   <p>
    <span class="s s293">Specific spam features (e.</span><span class="s s294">g.</span> <span class="s s295">not seeing the recipient's
address in the to: field) do of course have value in 
recognizing spam.</span>  <span class="s s296">They can be considered in this
algorithm by treating them as virtual words.</span>  <span class="s s297">I'll probably
do this in future versions, at least for a handful of the
most egregious spam indicators.</span> <span class="s s298">Feature-recognizing
spam filters are right in many details; what they lack
is an overall discipline for combining evidence.</span>
   </p>
   <p>
    <span class="s s300">Recognizing nonspam features may be more important than
recognizing spam features.</span>  <span class="s s301">False positives are such a
worry that they demand extraordinary measures.</span>  <span class="s s302">I will
probably in future versions add a second level of testing
designed specifically to avoid false positives.</span>  <span class="s s303">If a
mail triggers this second level of filters it will be accepted
even if its spam probability is above the threshold.</span>
   </p>
   <p>
    <span class="s s305">I don't expect this second level of filtering to be Bayesian.</span>
<span class="s s306">It will inevitably 
be not only ad hoc, but based on guesses, because the number of
false positives will not tend to be large enough to notice patterns.</span>
<span class="s s307">(It is just as well, anyway, if a backup system doesn't rely on the same
technology as the primary system.</span><span class="s s308">)</span>
   </p>
   <p>
    <span class="s s309">Another thing I may try in the future is to focus extra attention
on specific parts of the email.</span>  <span class="s s310">For example, about 95% of current
spam includes the url of a site they want
you to visit.</span>  <span class="s s311">(The remaining 5% want you to call a phone number,
reply by email or to a US mail address, or in a few
cases to buy a certain stock.</span><span class="s s312">)   The url is in such cases
practically enough by itself to determine whether the email
is spam.</span>
   </p>
   <p>
    <span class="s s314">Domain names differ from the rest of the text in
a (non-German) email in that they often consist of several
words stuck together.</span>  <span class="s s315">Though computationally expensive 
in the general case, it might be worth trying to 
decompose them.</span>  <span class="s s316">If a filter has never seen the
token "xxxporn" before it will have an individual spam
probability of .</span><span class="s s317">4, whereas "xxx" and "porn" individually
have probabilities (in my corpus) of .</span><span class="s s318">9889 and .</span><span class="s s319">99
respectively, and a combined probability of .</span><span class="s s320">9998.</span>
   </p>
   <p>
    <span class="s s322">I expect decomposing domain names to become more
important as spammers are gradually forced to stop using
incriminating words in the text of their messages.</span>  <span class="s s323">(A url
with an ip address is of course an extremely incriminating sign,
except in the mail of a few sysadmins.</span><span class="s s324">)</span>
   </p>
   <p>
    <span class="s s325">It might be a good idea to have a cooperatively maintained
list of urls promoted by spammers.</span>  <span class="s s326">We'd need a trust metric
of the type studied by Raph Levien to prevent malicious
or incompetent submissions, but if we had such a thing it
would provide a boost to any filtering software.</span>   <span class="s s327">It would
also be a convenient basis for boycotts.</span>
   </p>
   <p>
    <span class="s s329">Another way to test dubious urls would be to send out a
crawler to look at the site before the user looked at the
email mentioning it.</span>  <span class="s s330">You could use a Bayesian filter to
rate the site just as you would an email, and whatever
was found on the site could be included in calculating
the probability of the email being a spam.</span>  <span class="s s331">A url that led
to a redirect would of course be especially suspicious.</span>
   </p>
   <p>
    <span class="s s333">One cooperative project that I think really would be a good
idea would be to accumulate a giant corpus of spam.</span>  <span class="s s334">A large,
clean corpus is the key to making Bayesian filtering work
well.</span>  <span class="s s335">Bayesian filters could actually use the corpus as
input.</span>  <span class="s s336">But such a corpus would be useful for other kinds
of filters too, because it could be used to test them.</span>
   </p>
   <p>
    <span class="s s338">Creating such a corpus poses some technical problems.  We'd
need trust metrics to prevent malicious or incompetent
submissions, of course.</span>  <span class="s s339">We'd also need ways of erasing   
personal information (not just to-addresses and ccs, but
also e.</span><span class="s s340">g.</span> <span class="s s341">the arguments to unsubscribe urls, which often
encode the to-address) from mails in the corpus.</span>  <span class="s s342">If anyone
wants to take on this project, it would be a good thing for
the world.</span>
   </p>
   <h3><span class="s s344">
    Appendix: Defining Spam
   </span></h3>
   <p>
    <span class="s s345">I think there is a rough
consensus on what spam is, but it would be useful to have
an explicit definition.</span>  <span class="s s346">We'll need to do this if we want to establish
a central corpus of spam, or even to compare spam filtering
rates meaningfully.</span>
   </p>
   <p>
    <span class="s s348">To start with, spam is not unsolicited commercial email.</span>
<span class="s s349">If someone in my neighborhood heard that I was looking for an old
Raleigh three-speed in good condition, and sent me an email
offering to sell me one, I'd be delighted, and yet this
email would be both commercial and unsolicited.</span><span class="s s350">  The
defining feature of spam (in fact, its
    <i>
     raison d'etre
    </i>
    )
is not that it is unsolicited, but that it is automated.</span>
   </p>
   <p>
    <span class="s s352">It is merely incidental, too, that spam is usually commercial.</span>
<span class="s s353">If someone started sending mass email to support some political
cause, for example, it would be just as much spam as email
promoting a porn site.</span>
   </p>
   <p><span class="s s355">
    I propose we define spam as
    <b>
     unsolicited automated email
    </b>
    .</span>
<span class="s s356">This definition thus includes some email
that many legal definitions of spam don't.</span>  <span class="s s357">Legal definitions
of spam, influenced presumably by lobbyists, tend to exclude
mail sent by companies that have an "existing relationship" with
the recipient.</span>  <span class="s s358">But buying something from a company, for
example, does not imply that you have solicited
ongoing email from them.</span>
<span class="s s359">If I order something from an online
store, and they then send me a stream of spam, it's still
spam.</span>
   </p>
   <p>
    <span class="s s361">Companies sending spam often give you a way to "unsubscribe,"
or ask you to go to their site and change your "account
preferences" if you want to stop getting spam.</span>  <span class="s s362">This is
not enough to stop the mail from being spam.</span>  <span class="s s363">Not opting out
is not the same as opting in.</span>  <span class="s s364">Unless the   
recipient explicitly checked a clearly labelled box (whose
default was no) asking to receive the email, then it is spam.</span>
   </p>
   <p>
    <span class="s s366">In some business relationships, you do implicitly solicit
certain kinds of mail.</span>   <span class="s s367">When you order online, I think you
implicitly solicit a receipt, and notification when the
order ships.</span><span class="s s368">
I don't mind when Verisign sends me mail warning that
a domain name is about to expire (at least, if they are the
    <a target="_blank" href="http://siliconvalley.internet.com/news/article.php/1441651">
     actual 
registrar
    </a>
    for it).</span>  <span class="s s369">But when Verisign sends me
email offering a FREE Guide to Building My
E-Commerce Web Site, that's spam.</span>
   </p>
   <h3><span class="s s371">
    Notes:
   </span></h3>
   <p>
    <span class="s s372">[1] The examples in this article are translated
into Common Lisp for, believe it or not, greater accessibility.</span><span class="s s373">
The application described here is one that we wrote in order to
test a new Lisp dialect called
    <a target="_blank" href="http://paulgraham.com/arc.html">
     Arc
    </a>
    that is 
not yet released.</span>
   </p>
   <p>
    <span class="s s375">[2] Currently the lowest rate seems to be about $200 to send a million spams.
That's very cheap, 1/50th of a cent per spam.</span>
<span class="s s376">But filtering out 95%
of spam, for example, would increase the spammers' cost to reach
a given audience by a factor of 20.</span>  <span class="s s377">Few can have
margins big enough to absorb that.</span>
   </p>
   <p>
    <span class="s s379">[3] As a rule of thumb, the more qualifiers there are before the
name of a country, the more corrupt the rulers.</span>  <span class="s s380">A
country called The Socialist People's Democratic Republic
of X is probably the last place in the world you'd want to live.</span>
   </p>
   <h3>
    <span class="s s382">Thanks
    to Sarah Harlin for reading drafts of this; Daniel Giffin (who is 
also writing the production Arc interpreter) for several good ideas about
filtering and for creating our mail infrastructure; Robert Morris,
Trevor Blackwell and Erann Gat for many discussions about spam; Raph 
Levien for advice about trust metrics;  and Chip Coldwell 
and Sam Steingold for advice about statistics.</span>
   </h3>
  
  <p>
  </p>
  <h3><span class="s s384">
   More Info:
  </span></h3>
  <p><span class="s s385">
   This essay was originally published at
   <a target="_blank" href="http://www.paulgraham.com/spam.html?utm_source=pgebook">
    paulgraham.com
   </a>
   </span></p><p>
   </p>
  
 </body></html>
